name: "On-Chain Anomaly Detection"

# Grant write access so `git push` works
permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours -> 00:00, 06:00, 12:00, 18:00 UTC

jobs:
  detect:
    runs-on: ubuntu-latest
    env:
      ETH_RPC: ${{ secrets.ETH_RPC }}
      WINDOW: 1000
      CONTAMINATION: 0.01

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # Make sure the checkout action uses GITHUB_TOKEN to auth subsequent git commands
          persist-credentials: true

      - name: Dump ETH_RPC presence
        run: |
          if [ -z "${ETH_RPC}" ]; then
            echo "ðŸ’¥ ETH_RPC is empty!" && exit 1
          else
            echo "âœ… ETH_RPC is set."
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies and run detector
        run: |
          pip install pandas scikit-learn web3
          python scripts/detect_anomalies.py \
            --window $WINDOW \
            --contamination $CONTAMINATION \
            --out data/anomalies.json

      - name: Commit findings
        run: |
          git config user.name "cspannos"
          git config user.email "cspannos@users.noreply.github.com"
          git add data/anomalies.json
          if [[ -n "$(git status --porcelain)" ]]; then
            git commit -m "chore: log on-chain anomalies"
            git push
          else
            echo "No changes to commit"
          fi
