name: "On-Chain Anomaly Detection"
on:
  workflow_dispatch:   # allows manual runs
  schedule:
    - cron: '*/15 * * * *'  # every 15 minutes

jobs:
  detect:
    runs-on: ubuntu-latest
    environment: Anomolies      # ‚Üê tell GH Actions to load that environment‚Äôs secrets
    env:
      WINDOW: 1000
      CONTAMINATION: 0.01

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Dump ETH_RPC presence
        run: |
          if [ -z "${ETH_RPC}" ]; then
            echo "üí• ETH_RPC is empty!" && exit 1
          else
            echo "‚úÖ ETH_RPC is set."
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies and run detector
        run: |
          pip install pandas scikit-learn web3
          python scripts/detect_anomalies.py \
            --window $WINDOW \
            --contamination $CONTAMINATION \
            --out data/anomalies.json

      - name: Commit findings
        run: |
          git config user.name "cspannos"
          git config user.email "cspannos@users.noreply.github.com"
          git add data/anomalies.json
          git diff --quiet || git commit -m "chore: log on-chain anomalies" && git push
